---
editLink: false
---

# @compas\/store

## newPostgresConnection

_Available since 0.1.0_

_function newPostgresConnection({Postgres["connectionOptions"]} [opts]):
Promise\<Postgres>_

Create a new postgres connection, using the default environment variables. A
database may be created using the provided credentials.

**Parameters**:

- {Postgres["connectionOptions"]} [opts]
  `{Postgres["connectionOptions"]} [opts]`: {Postgres["connectionOptions"]}
  [opts]

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/postgres.js#L48)_

## setStoreQueries

_Available since 0.1.0_

_function setStoreQueries({typeof
import("./generated/database/index.js").queries} q): void_

Overwrite used generated queries. This is needed when you want cascading soft
deletes to any of the exposed types. It is mandatory to be called if 'files',
'session' or 'jobs' are used. If you don't use the generators, you can use
`storeQueries` as exported by `@compas/store`.

**Parameters**:

- {typeof import("./generated/database/index.js").queries} q
  `{typeof import("./generated/database/index.js").queries} q`: {typeof
  import("./generated/database/index.js").queries} q

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/generated.js#L15)_

## query

_Available since 0.1.0_

_function query({TemplateStringsArray | string[]} strings, {...(QueryPartArg |
QueryPartArg[])} values): {import("../types/advanced-types").QueryPart\<T>}_

Format and append query parts, and execute the final result in a safe way.
Undefined values are skipped, as they are not allowed in queries. The query call
may be one of the interpolated values. Supports being called as a template
literal.

**Parameters**:

- {TemplateStringsArray | string[]} strings
  `{TemplateStringsArray | string[]} strings`: {TemplateStringsArray | string[]}
  strings
- {...(QueryPartArg | QueryPartArg[])} values
  `{...(QueryPartArg | QueryPartArg[])} values`: {...(QueryPartArg |
  QueryPartArg[])} values

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L27)_

## isQueryPart

_Available since 0.1.0_

_function isQueryPart(query): {query is
import("../types/advanced-types").QueryPart\<any>}_

Check if the passed in value is an object generated by 'query``'.

**Parameters**:

- query `any`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L110)_

## stringifyQueryPart

_Available since 0.1.0_

_function stringifyQueryPart({import("../types/advanced-types").QueryPart\<any>}
queryPart, options): {string|{ sql?: string, params?:[] }}_

Stringify a queryPart. When interpolateParameters is true, we do a best effort
in replacing the parameterized query with the real params. If the result doesn't
look right, please turn it off.

**Parameters**:

- {import("../types/advanced-types").QueryPart\<any>} queryPart
  `{import("../types/advanced-types").QueryPart\<any>} queryPart`:
  {import("../types/advanced-types").QueryPart\<any>} queryPart
- options `{ interpolateParameters?: boolean }`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L129)_

## explainAnalyzeQuery

_Available since 0.1.0_

_function explainAnalyzeQuery(sql,
{import("../types/advanced-types").QueryPart\<any>} queryItem, options?):
Promise\<string|object>_

Creates a transaction, executes the query, and rollback the transaction
afterwards. This is safe to use with insert, update and delete queries. By
default returns text, but can also return json. Note that explain output is
highly depended on the current data and usage of the tables.

**Parameters**:

- sql `Postgres`
- {import("../types/advanced-types").QueryPart\<any>} queryItem
  `{import("../types/advanced-types").QueryPart\<any>} queryItem`:
  {import("../types/advanced-types").QueryPart\<any>} queryItem
- options `{ jsonResult?: boolean }={}`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/query.js#L181)_

## newMigrateContext

_Available since 0.1.0_

_function newMigrateContext(sql, migrationDirectory): Promise\<MigrateContext>_

Create a new migration context, resolves all migrations and collects the current
migration state.

**Parameters**:

- sql `Postgres`
- migrationDirectory `string`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L42)_

## getMigrationsToBeApplied

_Available since 0.1.0_

_function getMigrationsToBeApplied(mc): { migrationQueue: { name: string,
number: number, repeatable: boolean _

Get the migrations to be applied from the provided migration context. Note that
'repeatable' migrations are always in both the `migrationQueue` and
`hashChanges`.

**Parameters**:

- mc `MigrateContext`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L111)_

## runMigrations

_Available since 0.1.0_

_function runMigrations(mc): Promise\<void>_

Run the migrations currently pending in the migration context.

**Parameters**:

- mc `MigrateContext`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/migrations.js#L142)_

## addEventToQueue

_Available since 0.1.0_

_function addEventToQueue(sql, eventName, data): Promise\<number>_

Add an event to the job queue. Use this if the default priority is important,
like sending the user an email to verify their email. Runs with priority '2',
the only higher priority values are priority '0' and '1'. Custom timeouts can't
be described via this mechanism.

**Parameters**:

- sql `Postgres`
- eventName `string`
- data `Record\<string, any>`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L471)_

## addJobToQueue

_Available since 0.1.0_

_function addJobToQueue(sql, job): Promise\<number>_

Add a new job to the queue. Use this for normal jobs or to customize the job
priority. The default priority is '5'.

**Parameters**:

- sql `Postgres`
- job `JobInput`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L493)_

## addRecurringJobToQueue

_Available since 0.1.0_

_function addRecurringJobToQueue(sql, job): Promise\<void>_

Add a recurring job, if no existing job with the same name is scheduled. Does
not throw when a job is already pending with the same name. If exists will
update the interval. The default priority is '4', which is a bit more important
than other jobs.

**Parameters**:

- sql `Postgres`
- job
  `{ name: string, priority?: number|undefined, interval: StoreJobInterval }`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L563)_

## addJobWithCustomTimeoutToQueue

_Available since 0.1.0_

_function addJobWithCustomTimeoutToQueue(sql, job, timeout): Promise\<number>_

Add a new job to the queue. Use this for normal jobs or to customize the job
priority. The default priority is '5'. The timeout value must be an integer
higher than 10. The timeout value represents the number of milliseconds the
handler may run, before the 'InsightEvent' is aborted.

**Parameters**:

- sql `Postgres`
- job `JobInput`
- timeout `number`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L525)_

## getUncompletedJobsByName

_Available since undefined_

_function getUncompletedJobsByName(sql): {Promise\<Object\<string,
QueryResultStoreJob[]>>}_

Get all uncompleted jobs from the queue. Useful for testing if jobs are created.

**Parameters**:

- sql `Postgres`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/queue.js#L724)_

## newSessionStore

_Available since 0.1.0_

_function newSessionStore({import("../types/advanced-types").Postgres} sql):
SessionStore_

Create a new session store, to be used in combination with the `session` as
provided in `@compas/server`.

**Parameters**:

- {import("../types/advanced-types").Postgres} sql
  `{import("../types/advanced-types").Postgres} sql`:
  {import("../types/advanced-types").Postgres} sql

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/sessions.js#L54)_

## newMinioClient

_Available since 0.1.0_

_function newMinioClient(opts): MinioClient_

Create a minio client with the default environment variables as defaults. Minio
is an S3 compatible client, so can be used against any S3 compatible interface.

**Parameters**:

- opts `minio.ClientOptions`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L17)_

## ensureBucket

_Available since 0.1.0_

_function ensureBucket(minio, bucketName, region): Promise\<void>_

Make sure a bucket exists and if it doesn't create it.

**Parameters**:

- minio `MinioClient`
- bucketName `string`
- region `string`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L42)_

## removeBucket

_Available since 0.1.0_

_function removeBucket(minio, bucketName): Promise\<void>_

Remove the provided bucket name. Note that this will fail if a bucket has
objects.

**Parameters**:

- minio `MinioClient`
- bucketName `string`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L82)_

## listObjects

_Available since 0.1.0_

_function listObjects(minio, bucketName, filter?): Promise\<{name: string,
prefix: string, size: number, etag: string, lastModified: Date_

List all objects in a bucket.

**Parameters**:

- minio `MinioClient`
- bucketName `string`
- filter `string?`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L60)_

## removeBucketAndObjectsInBucket

_Available since 0.1.0_

_function removeBucketAndObjectsInBucket(minio, bucketName): Promise\<void>_

Force removal of a bucket by listing and removing it's objects.

**Parameters**:

- minio `MinioClient`
- bucketName `string`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/minio.js#L95)_

## createOrUpdateFile

_Available since 0.1.0_

_function createOrUpdateFile(sql, minio, bucketName,
{{ id?: undefined | string;   contentLength?: number;   bucketName?: string;   contentType: string;   name: string;   meta?:     | undefined     | {         transforms?: undefined | any;         transformedFromOriginal?: undefined | string;       }     | object;   createdAt?: undefined | Date;   updatedAt?: undefined | Date;   deletedAt?: undefined | Date;  }}
props, source): Promise\<StoreFile>_

Create or update a file. The file store is backed by a Postgres table and S3
object.

**Parameters**:

- sql `Postgres`
- minio `MinioClient`
- bucketName `string`
- {{ id?: undefined | string;   contentLength?: number;   bucketName?: string;   contentType: string;   name: string;   meta?:     | undefined     | {         transforms?: undefined | any;         transformedFromOriginal?: undefined | string;       }     | object;   createdAt?: undefined | Date;   updatedAt?: undefined | Date;   deletedAt?: undefined | Date;  }}
  props
  `{{ id?: undefined | string; contentLength?: number; bucketName?: string; contentType: string; name: string; meta?: | undefined | { transforms?: undefined | any; transformedFromOriginal?: undefined | string; } | object; createdAt?: undefined | Date; updatedAt?: undefined | Date; deletedAt?: undefined | Date; }} props`:
  {{ id?: undefined | string;   contentLength?: number;   bucketName?: string;   contentType: string;   name: string;   meta?:     | undefined     | {         transforms?: undefined | any;         transformedFromOriginal?: undefined | string;       }     | object;   createdAt?: undefined | Date;   updatedAt?: undefined | Date;   deletedAt?: undefined | Date;  }}
  props
- source `NodeJS.ReadableStream|string|Buffer`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L61)_

## copyFile

_Available since 0.1.0_

_function copyFile(sql, minio, bucketName, id, targetBucket?):
Promise\<StoreFile>_

Create both a Postgres record copy and an S3 object copy of the provided file
id, into the provided bucket.

**Parameters**:

- sql `Postgres`
- minio `MinioClient`
- bucketName `string`
- id `string`
- targetBucket `string=bucketName`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L144)_

## getFileStream

_Available since 0.1.0_

_function getFileStream(minio, bucketName, id, seek?):
Promise\<NodeJS.ReadableStream>_

Get a file stream based on the 'id'. It is expected that an object exists with
the 'id'. A 'start' and 'end' value can optionally be specified.

**Parameters**:

- minio `MinioClient`
- bucketName `string`
- id `string`
- seek `{ start?: number|undefined, end?: number|undefined }={}`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L116)_

## syncDeletedFiles

_Available since 0.1.0_

_function syncDeletedFiles(sql, minio, bucketName): Promise\<number>_

File deletes should be done via `queries.storeFileDeletePermanent()`. By calling
this function, all files that don't exist in the database will be removed from
the S3 bucket.

**Parameters**:

- sql `Postgres`
- minio `MinioClient`
- bucketName `string`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/files.js#L183)_

## updateFileGroupOrder

_Available since 0.1.0_

_function updateFileGroupOrder(sql, {string[]} ids): Promise\<void>_

Update the order of the provided id's in relation to each other. This function
does not check if all files are in the same group, please use
getFileGroupParents for that.

**Parameters**:

- sql `Postgres`
- {string[]} ids `{string[]} ids`: {string[]} ids

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/file-group.js#L59)_

## createTestPostgresDatabase

_Available since 0.1.0_

_function createTestPostgresDatabase(verboseSql?,
{Postgres["connectionOptions"]} [rawOpts]): Promise\<Postgres>_

Create a new test database, using the default database as it's template. The
copied database will be fully truncated, except for the 'migrations' table. To
do this, all connections to the default database are forcefully killed. Returns
a connection to the new database.

**Parameters**:

- verboseSql `boolean=false`: If true, creates a new logger and prints all
  queries.
- {Postgres["connectionOptions"]} [rawOpts]
  `{Postgres["connectionOptions"]} [rawOpts]`: {Postgres["connectionOptions"]}
  [rawOpts]

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/testing.js#L68)_

## cleanupTestPostgresDatabase

_Available since 0.1.0_

_function cleanupTestPostgresDatabase(sql): Promise\<void>_

Try to remove a test database. Can only happen if the connection is created by
'createTestPostgresDatabase'.

**Parameters**:

- sql `Postgres`

_[source](https://github.com/compasjs/compas/blob/main/packages/store/src/testing.js#L160)_
